# Python package
# Create and test a Python package on multiple Python versions.
# Add steps that analyze code, save the dist with the build record, publish to a PyPI-compatible index, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/python

trigger:
- master

jobs:
- job: Python
  pool:
    vmImage: 'ubuntu-latest'
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
        tox.env: 'py36-azure'
      Python37:
        python.version: '3.7'
        tox.env: 'py37-azure'
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '$(python.version)'
    displayName: 'Use Python $(python.version)'
  - script: |
      python -m pip install --upgrade pip
      pip install tox
    displayName: 'Install tox'
  - script: |
      tox -e $(tox.env)
    displayName: 'tox $(tox.env)'
  - task: PublishTestResults@2
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/TEST-*.xml'
      failTaskOnFailedTests: true
  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: 'coverage.xml'
- job: SonarCloud
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.7'
    displayName: 'Use Python 3.7'
  - task: SonarCloudPrepare@1
    inputs:
      SonarCloud: 'SonarCloud'
      organization: 'anited'
      scannerMode: 'CLI'
      configMode: 'file'
      extraProperties: |
        sonar.projectKey=publish
        sonar.python.coverage.reportPaths=$(Build.SourcesDirectory)/coverage.xml
        sonar.exclusions=**/publish/template.html
        sonar.coverage.exclusions=setup.py,tests/**,examples/**
  - script: |
      python -m pip install --upgrade pip
      pip install tox
    displayName: 'Install tox'
  - script: |
      tox -e py37-azure
    displayName: 'tox py37-azure'
  - task: SonarCloudAnalyze@1
